FROM ollama/ollama:latest

# Install curl
RUN apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*

# Create startup script
COPY <<EOF /start.sh
#!/bin/bash
set -e

echo "🚀 Starting Ollama server..."

# Set environment variables
export OLLAMA_HOST=0.0.0.0:11434
export OLLAMA_ORIGINS="*"

# Start Ollama in background
ollama serve &
OLLAMA_PID=\$!

# Wait for server to be ready
echo "⏳ Waiting for server to start..."
for i in {1..30}; do
    if curl -s http://localhost:11434/api/tags > /dev/null 2>&1; then
        echo "✅ Server is ready!"
        break
    fi
    echo "Attempt \$i/30..."
    sleep 2
done

# Pull the model
echo "📦 Pulling gemma3:1b model..."
ollama pull gemma3:1b

echo "🎉 Setup complete! Server running on 0.0.0.0:11434"

# Wait for background process
wait \$OLLAMA_PID
EOF

# Make script executable
RUN chmod +x /start.sh

# Expose port
EXPOSE 11434

# Override entrypoint and run our script
ENTRYPOINT []
CMD ["/bin/bash", "/start.sh"]
